<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Coach</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class'
    }
  </script>
</head>
<body class="min-h-screen flex flex-col bg-[#F9FAFB] text-[#212121] dark:bg-[#121212] dark:text-white">
  <!-- Navbar -->
  <nav class="bg-white dark:bg-[#1E1E1E] shadow-md px-6 py-4 flex justify-between items-center">
    <h2 class="text-2xl font-bold">AI Coach</h2>
    <div class="flex gap-3">
      <a href="dashboard.html" 
         class="px-4 py-2 rounded-lg bg-[#00B248] dark:bg-[#00C853] text-white font-semibold hover:opacity-90 transition">
        Dashboard
      </a>
      <button id="themeToggle" 
              class="px-4 py-2 rounded-lg bg-[#1976D2] dark:bg-[#1E90FF] text-white font-semibold hover:opacity-90 transition">
        Toggle Theme
      </button>
      <button id="logoutBtn" 
              class="px-4 py-2 rounded-lg bg-[#00B248] dark:bg-[#00C853] text-white font-semibold hover:opacity-90 transition">
        Logout
      </button>
    </div>
  </nav>

  <!-- Main -->
  <main class="flex-1 flex flex-col items-center justify-center p-6 text-center">
    <h1 class="text-4xl font-extrabold mb-6">AI Coach</h1>

    <form id="settings" 
          class="flex flex-col items-center gap-4 bg-white dark:bg-[#1E1E1E] p-6 rounded-xl shadow-md w-full max-w-md"
          onsubmit="event.preventDefault(); applySettings();">
      <label for="exercise" class="text-lg font-semibold">Choose starting exercise:</label>
      <select id="exercise" 
              class="p-3 rounded-lg border border-[#1976D2] dark:border-[#1E90FF] w-full bg-white dark:bg-[#1E1E1E] text-[#212121] dark:text-white">
        <option value="squat">Squat</option>
        <option value="pushup">Push-up</option>
      </select>
      <button type="submit" 
              class="mt-4 px-6 py-3 rounded-lg bg-[#00B248] dark:bg-[#00C853] text-white font-semibold hover:opacity-90 transition">
        Start
      </button>
    </form>

    <div id="status" class="mt-6 text-lg font-medium text-[#616161] dark:text-[#B3B3B3]">
      Waiting for selection...
    </div>

    <div id="video-container" class="mt-8 flex justify-center">
      <img id="video" class="rounded-xl shadow-lg hidden" />
    </div>

    <div id="bar" class="mt-6 flex gap-4">
      <button onclick="requestFeedback()" 
              class="px-4 py-2 bg-[#1976D2] dark:bg-[#1E90FF] text-white rounded-lg font-semibold hover:opacity-90 transition">
        Last-set feedback
      </button>
      <button onclick="saveWorkouts()" 
              class="px-4 py-2 bg-[#00B248] dark:bg-[#00C853] text-white rounded-lg font-semibold hover:opacity-90 transition">
        Save Workouts
      </button>
    </div>
  </main>

  <!-- Your JS (unchanged) -->
  <script>
    const BASE = "http://localhost:8000";
    const audioEl = new Audio();
    let feedbackTimer = null;
    let lastFeedbackSeq = -1;

    async function saveWorkouts() {
      const res = await authFetch(`${BASE}/workouts/flush`, { method: "POST" });
      if (!res) return;
      const data = await res.json();
      alert(`Saved ${data.saved || 0} workouts to DB`);
    }

    function requireAuth() {
      const token = localStorage.getItem("access_token");
      if (!token) {
        window.location.href = "login.html";
        return null;
      }
      return token;
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("access_token");
      window.location.href = "login.html";
    });

    async function authFetch(url, options = {}) {
      const token = requireAuth();
      if (!token) return;

      const opts = {
        ...options,
        headers: {
          ...(options.headers || {}),
          "Authorization": `Bearer ${token}`
        }
      };

      const res = await fetch(url, opts);
      if (res.status === 401) {
        alert("Session expired. Please login again.");
        localStorage.removeItem("access_token");
        window.location.href = "login.html";
        return null;
      }
      return res;
    }

    async function applySettings() {
      const exercise = document.getElementById("exercise").value;
      try {
        const res = await authFetch(`${BASE}/set_config?exercise=${exercise}`);
        if (!res) return;
        const data = await res.json();

        if (data.status === "ok") {
          document.getElementById("status").innerText = `Config set: ${data.exercise}`;
          const videoEl = document.getElementById("video");
          const token = localStorage.getItem("access_token");
          videoEl.src = `${BASE}/video?token=${token}&t=` + new Date().getTime();
          videoEl.style.display = "block";
          startCuePolling();
          startFeedbackPolling();
        } else {
          document.getElementById("status").innerText = "" + data.msg;
        }
      } catch (err) {
        document.getElementById("status").innerText = "Failed to connect to backend.";
      }
    }

    async function pollCoachCue() {
      try {
        const res = await authFetch(`${BASE}/coach_cue`);
        if (!res) return;
        const data = await res.json();
        if (data.url) {
          console.log("Cue:", data);
          audioEl.src = BASE + data.url;
          audioEl.play();
        }
      } catch (err) {
        console.error("Cue polling failed", err);
      }
    }

    function startCuePolling() {
      setInterval(pollCoachCue, 1000);
    }

    async function requestFeedback() {
      try {
        const res = await authFetch(`${BASE}/ai/feedback`, { method: "POST" });
        if (!res) return;
        const data = await res.json();
        if (data.audio_url) {
          console.log("Feedback:", data.text);
          const a = new Audio(BASE + data.audio_url);
          a.play();
        } else {
          alert("No finished set to summarize yet.");
        }
      } catch (e) {
        console.error("feedback error", e);
      }
    }

    function startFeedbackPolling() {
      if (feedbackTimer) return;
      feedbackTimer = setInterval(async () => {
        try {
          const res = await authFetch(`${BASE}/ai/feedback/status`);
          if (!res) return;
          const s = await res.json();
          if (!s.ready) return;
          if (s.seq <= lastFeedbackSeq) return;

          const res2 = await authFetch(`${BASE}/ai/feedback`, { method: "POST" });
          if (!res2) return;
          const data = await res2.json();
          lastFeedbackSeq = s.seq;

          if (data && data.audio_url) {
            const a = new Audio(BASE + data.audio_url);
            a.play();
          }

          stopFeedbackPolling();
        } catch (e) {
          console.warn("feedback poll error", e);
        }
      }, 1000);
    }

    function stopFeedbackPolling() {
      if (feedbackTimer) {
        clearInterval(feedbackTimer);
        feedbackTimer = null;
      }
    }

    window.onload = requireAuth;

    // Theme toggle (new, independent of app logic)
    const themeBtn = document.getElementById("themeToggle");
    if (localStorage.getItem("theme") === "dark") {
      document.documentElement.classList.add("dark");
    }
    themeBtn.addEventListener("click", () => {
      document.documentElement.classList.toggle("dark");
      if (document.documentElement.classList.contains("dark")) {
        localStorage.setItem("theme", "dark");
      } else {
        localStorage.setItem("theme", "light");
      }
    });
  </script>
</body>
</html>
